<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ‰‹å†™ç®€å•ç‰ˆç¬¦åˆ PromiseA+è§„èŒƒçš„ Promise | icyfe</title>
<link rel="shortcut icon" href="https://icyfe.github.io/icyblog//favicon.ico?v=1592891916589">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://icyfe.github.io/icyblog//styles/main.css">
<link rel="alternate" type="application/atom+xml" title="æ‰‹å†™ç®€å•ç‰ˆç¬¦åˆ PromiseA+è§„èŒƒçš„ Promise | icyfe - Atom Feed" href="https://icyfe.github.io/icyblog//atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="ä»Šå¤©æ‰‹å†™ä¸€ä¸ªç¬¦åˆ promiseA+è§„èŒƒçš„ promiseï¼Œè¿™ä¸ªçŸ¥è¯†ç‚¹å¯èƒ½å¿«è¢«å†™çƒ‚äº†å§ï¼Œä½†è¿˜æ˜¯ä½œä¸ºå­¦ä¹ æ¯”è¾ƒåŠ æ·±è‡ªå·±å¯¹ Promise çš„ç†è§£ã€‚
å…ˆæ¥äº†è§£ Promise æ˜¯ä»€ä¹ˆï¼Œpromise çš„å‡ºç°ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œæœ€åæˆ‘ä»¬æ ¹æ® prom..." />
    <meta name="keywords" content="javascript" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://icyfe.github.io/icyblog/">
  <img class="avatar" src="https://icyfe.github.io/icyblog//images/avatar.png?v=1592891916589" alt="">
  </a>
  <h1 class="site-title">
    icyfe
  </h1>
  <p class="site-description">
    å¥½å¥½å­¦ä¹ å¤©å¤©å‘ä¸ŠğŸŒ¸
  </p>
  <div class="menu-container">
    
      
        <a href="https://icyfe.github.io/icyblog/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="https://icyfe.github.io/icyblog/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="https://icyfe.github.io/icyblog/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="https://icyfe.github.io/icyblog/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              æ‰‹å†™ç®€å•ç‰ˆç¬¦åˆ PromiseA+è§„èŒƒçš„ Promise
            </h2>
            <div class="post-info">
              <span>
                2020-06-17
              </span>
              <span>
                13 min read
              </span>
              
                <a href="https://icyfe.github.io/icyblog/tag/Qh-_2RrfH/" class="post-tag">
                  # javascript
                </a>
              
            </div>
            
              <img class="post-feature-image" src="https://icyfe.github.io/icyblog//post-images/shou-xie-jian-dan-ban-fu-he-promiseagui-fan-de-promise.png" alt="">
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <p>ä»Šå¤©æ‰‹å†™ä¸€ä¸ªç¬¦åˆ promiseA+è§„èŒƒçš„ promiseï¼Œè¿™ä¸ªçŸ¥è¯†ç‚¹å¯èƒ½å¿«è¢«å†™çƒ‚äº†å§ï¼Œä½†è¿˜æ˜¯ä½œä¸ºå­¦ä¹ æ¯”è¾ƒåŠ æ·±è‡ªå·±å¯¹ Promise çš„ç†è§£ã€‚<br>
å…ˆæ¥äº†è§£ Promise æ˜¯ä»€ä¹ˆï¼Œpromise çš„å‡ºç°ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œæœ€åæˆ‘ä»¬æ ¹æ® promiseA+è‡ªå·±æ‰‹å†™å®ç°ä¸€ä¸ª promise</p>
<h2 id="ä¸€-promise-æ˜¯ä»€ä¹ˆ">ä¸€ã€Promise æ˜¯ä»€ä¹ˆï¼Ÿ</h2>
<p>è´´ä¸€æ®µ MDN çš„ä»‹ç»<br>
<code>Promise å¯¹è±¡ç”¨äºè¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„æœ€ç»ˆçŠ¶æ€ï¼ˆå®Œæˆæˆ–å¤±è´¥ï¼‰ï¼Œä»¥åŠå…¶è¿”å›çš„å€¼..... Promise å¯¹è±¡æ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼ˆä»£ç†ä¸€ä¸ªå€¼ï¼‰ï¼Œè¢«ä»£ç†çš„å€¼åœ¨Promiseå¯¹è±¡åˆ›å»ºæ—¶å¯èƒ½æ˜¯æœªçŸ¥çš„ã€‚å®ƒå…è®¸ä½ ä¸ºå¼‚æ­¥æ“ä½œçš„æˆåŠŸå’Œå¤±è´¥åˆ†åˆ«ç»‘å®šç›¸åº”çš„å¤„ç†æ–¹æ³•ï¼ˆhandlersï¼‰ã€‚ è¿™è®©å¼‚æ­¥æ–¹æ³•å¯ä»¥åƒåŒæ­¥æ–¹æ³•é‚£æ ·è¿”å›å€¼ï¼Œä½†å¹¶ä¸æ˜¯ç«‹å³è¿”å›æœ€ç»ˆæ‰§è¡Œç»“æœï¼Œè€Œæ˜¯ä¸€ä¸ªèƒ½ä»£è¡¨æœªæ¥å‡ºç°çš„ç»“æœçš„promiseå¯¹è±¡ã€‚</code><br>
é€šä¿—ç‚¹æ¥è¯´å°±æ˜¯è§£å†³å¼‚æ­¥æ“ä½œé—®é¢˜çš„ä¸€ä¸ªç±»ã€‚<br>
<a href="url">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise</a></p>
<h2 id="äºŒ-promise-çš„å‡ºç°ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜">äºŒã€Promise çš„å‡ºç°ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ</h2>
<p>ç›¸ä¿¡æ¥è§¦è¿‡å¼‚æ­¥æ“ä½œçš„åŒå­¦éƒ½ç»å†è¿‡å›è°ƒåœ°ç‹±ï¼Œä¸€ä¸ªå¼‚æ­¥æ¥ç€ä¸€ä¸ªå¼‚æ­¥å¦‚ä¸‹æ‰€ç¤º</p>
<pre><code class="language-js">asyncFunc1(opt, (...args1) =&gt; {
  asyncFunc2(opt, (...args2) =&gt; {
    asyncFunc3(opt, (...args3) =&gt; {
      asyncFunc4(opt, (...args4) =&gt; {
        // some operation
      });
    });
  });
});
</code></pre>
<p>è¿™æ ·çš„ä»£ç ä¸ä»…éš¾ä»¥ç»´æŠ¤ï¼Œå¯è¯»æ€§ä¹Ÿå·®ç®€ç›´ç—›è‹¦ï¼ŒPromise çš„å‡ºç°é€šè¿‡é“¾å¼è°ƒç”¨å¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šè§£å†³å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œé€šè¿‡ Promise å¯ä»¥å†™æˆè¿™æ ·</p>
<pre><code>asyncFunc1('...â€œ).then(res=&gt; {
    return asyncFunc2(res);
}).then(res =&gt; {
    return asyncFunc3(res);
}).then(res =&gt; {
   return asyncFunc4(res);
}).then(res =&gt;{
console.log(res)
})
</code></pre>
<p>è¿™æ ·çš„æ¯ä¸€æ¬¡çš„ then çš„è¿”å›å€¼éƒ½å¯ä»¥ä½œä¸ºä¸‹ä¸€ä¸ªçš„å¼‚æ­¥æ“ä½œçš„å‚æ•°ï¼Œè¿™æ ·å›è°ƒåœ°ç‹±çš„é—®é¢˜å°±è½»æ˜“è§£å†³äº†ã€‚<br>
æœ¬æ–‡å¯¹ Promise çš„ç”¨æ³•ä¸å¤šåšä»‹ç»è·Ÿå¤šçš„ç”¨æ³•å¯çœ‹é˜®ä¸€å³°è€å¸ˆçš„ es6 å…¥é—¨<a href="url">http://es6.ruanyifeng.com/</a></p>
<h2 id="ä¸‰-æ‰‹å†™ä¸€ä¸ªç¬¦åˆ-promiseaè§„èŒƒçš„-promise">ä¸‰ã€æ‰‹å†™ä¸€ä¸ªç¬¦åˆ PromiseA+è§„èŒƒçš„ Promise</h2>
<p>å¼€å§‹å†™ä¹‹å‰è´´ä¸Š PromiseA+è§„èŒƒçš„é“¾æ¥ <a href="url">http://www.ituring.com.cn/article/66566</a><br>
<strong>1ã€é¦–å…ˆ Promise æœ‰ä¸‰ç§çŠ¶æ€ç­‰å¾…(pending),<br>
æˆåŠŸæ€(fulfilled,è§„èŒƒä¸­ç§°ä¸ºæ‰§è¡Œæ€æˆ‘è®¤ä¸ºè§£é‡Šä¸ºæˆåŠŸæ€æˆ–è€…å®Œæˆæ€æ›´å¥½ç†è§£),<br>
å¤±è´¥(rejected),å¹¶ä¸”åªèƒ½ä¸ºä»¥ä¸Šä¸‰ç§çŠ¶æ€çš„å…¶å®ä¸€ç§ï¼Œç­‰å¾…æ€å¯æ”¹å˜ä¸ºæˆåŠŸæ€æˆ–è€…å¤±è´¥æ€ï¼ŒæˆåŠŸæ€æœ‰æˆåŠŸçš„å€¼ä¸èƒ½æ”¹å˜ä¸ºå…¶ä»–ä»»ä½•çŠ¶æ€ï¼Œå¤±è´¥æ€æœ‰å¤±è´¥çš„å€¼ä¸èƒ½æ”¹å˜ä¸ºå…¶ä»–ä»»ä½•çŠ¶æ€ã€‚<br>
2ã€Promise æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°æ–‡æ¡£ä¸­ç§°ä¸ºâ€˜executorâ€™ç¿»è¯‘è¿‡æ¥å°±æ˜¯æ‰§è¡Œè€…è¯´æ˜åœ¨æ„é€ å‡½æ•°ä¸€è°ƒç”¨çš„æ—¶å€™å°±è¢«æ‰§è¡Œï¼Œè¿™ä¸ª executor å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ resolve,rejectï¼Œå½“ executor å‡½æ•°ä¸­çš„ resovle å‡½æ•°è¢«è°ƒç”¨æ—¶çŠ¶æ€æ”¹å˜ä¸ºæˆåŠŸæ€(fulfiiled)ï¼Œreject å‡½æ•°è¢«è°ƒç”¨æ—¶çŠ¶æ€å°±æ”¹å˜ä¸ºå¤±è´¥æ€(rejected),å½“ executor å‡½æ•°æ‰§è¡Œå‡ºé”™æ—¶å°±ç›´æ¥è°ƒç”¨ reject æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬è¦æ•è· executor å‡½æ•°æ‰§è¡Œæ—¶çš„å¼‚å¸¸ã€‚</strong></p>
<p>æ ¹æ®è¿™ä¸¤æ¡æˆ‘ä»¬å†™åˆå§‹çš„ä»£ç </p>
<pre><code class="language-js">class Promise {
  constructor(executor) {
    //çŠ¶æ€
    this.status = 'pending';
    //å¤±è´¥çš„å€¼
    this.reason = null;
    //æˆåŠŸçš„å€¼
    this.value = null;

    let resolve = value =&gt; {
      if (this.status == 'pending') {
        this.status = 'fulfilled';
        this.value = value;
      }
    };
    let reject = reason =&gt; {
      if (this.status == 'pending') {
        this.status = 'rejected';
        this.reason = reason;
      }
    };
    //å½“è°ƒç”¨æ„é€ å‡½æ•°æ—¶å°±è°ƒç”¨executorå‡½æ•°å¹¶æ•è·å¼‚å¸¸
    try {
      executor(resolve, reject);
    } catch (error) {
      reject(error);
    }
  }
}
</code></pre>
<p><strong>3ã€promiseA+è§„å®šå¿…é¡»è¦æœ‰ä¸€ä¸ª then æ–¹æ³•å¯ä»¥è®¿é—®å…¶æˆåŠŸæˆ–å¤±è´¥æ—¶å€™çš„è¿”å›å€¼ï¼Œthen æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä¸º onFulfilled å’Œ onRejectdï¼Œå¹¶ä¸”è¿˜è§„å®šäº†å½“ä¸¤ä¸ªå‚æ•°ä¸æ˜¯å‡½æ•°æ—¶å…¶å€¼è¢«å¿½ç•¥</strong><br>
<strong>4ã€å½“ onFulfilled å’Œ onRejected æ˜¯å‡½æ•°æ—¶ï¼ŒonFulfilled å‡½æ•°åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œåœ¨ promise æ‰§è¡ŒæˆåŠŸç»“æŸåï¼Œå¹¶å°† promise çš„è¿”å›å€¼ä½œä¸ºç»ˆå€¼ï¼ŒonReject å‡½æ•°åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œå½“ promise è¢«æ‹’ç»æ‰§è¡Œåå…¶å¿…é¡»è¢«è°ƒç”¨ï¼Œå…¶ç¬¬ä¸€ä¸ªå‚æ•°ä¸º promise çš„æ®å› ã€‚</strong></p>
<p>æ ¹æ®è¿™ä¸¤æ¡æˆ‘ä»¬æ¥å†™ then çš„åˆå§‹æ–¹æ³•</p>
<pre><code class="language-js">//thenæ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°onFulfilled,onRejected
 then(onFulfilled, onRejected) {
     //å¦‚æœéå‡½æ•°å°±ç›´æ¥è¿”å›å€¼
     onFulfilled = typeof onFulfilled == 'function' ? onFulfilled : v =&gt; v
     // é”™è¯¯çš„å°±ç›´æ¥æŠ›é”™ä¸åœ¨æ‰§è¡Œ
     onRejected = typeof onRejected == 'function' ? onRejected : err =&gt; { throw err }
     //æˆåŠŸåç«‹å³æ‰§è¡Œ,å¹¶å°†å…¶ç»“æœä½œä¸ºå‚æ•°
     if (this.status == 'fulfilled') {
         onFulfilled(this.value)
     }
     // å¤±è´¥åç«‹å³æ‰§è¡Œ,å¹¶å°†å…¶æ‹’å› ä½œä¸ºå‚æ•°
     if (this.status == 'rejected') {
         onRejected(this.reason)
     }
 }
}
</code></pre>
<p><strong>5ã€then æ–¹æ³•å¯ä»¥è¢«åŒä¸€ä¸ª promise å¤šæ¬¡è°ƒç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤º<br>
let p = new Promise()<br>
p.then()<br>
p.then()<br>
å½“ promise æˆåŠŸæ‰§è¡Œæ—¶ï¼Œæ‰€æœ‰ onFulfilled éœ€æŒ‰ç…§å…¶æ³¨å†Œé¡ºåºä¾æ¬¡å›è°ƒ<br>
å½“ promise è¢«æ‹’ç»æ‰§è¡Œæ—¶ï¼Œæ‰€æœ‰çš„ onRejected éœ€æŒ‰ç…§å…¶æ³¨å†Œé¡ºåºä¾æ¬¡å›è°ƒ</strong></p>
<p>ä»¥ä¸Šä»£ç åªèƒ½è§£å†³åŒæ­¥é—®é¢˜ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬å¼‚æ­¥æ‰§è¡Œçš„æ—¶å€™æˆ‘ä»¬è¦æœ‰ä¸¤ä¸ªé˜Ÿåˆ—(å½“å¤šæ¬¡è°ƒç”¨çš„æ—¶å€™)åœ¨ç­‰å¾…çŠ¶æ€çš„æ—¶å€™åˆ†åˆ«å­˜æ”¾æˆåŠŸå’Œå¤±è´¥æ—¶å€™çš„å›è°ƒï¼Œå¹¶åœ¨çŠ¶æ€æ”¹å˜çš„æ—¶å€™ä¾æ¬¡å–å‡ºæ¥æ‰§è¡Œ</p>
<p>åœ¨æ„é€ å‡½æ•°æ·»åŠ ä»£ç </p>
<pre><code class="language-js">//æˆåŠŸå›è°ƒå­˜æ”¾
this.resolvedCallbacks = [];
//å¤±è´¥å›è°ƒå­˜æ”¾
this.rejectedCallbacks = [];
let resolve = value =&gt; {
  if (this.status == 'pending') {
    this.status = 'fulfilled';
    this.value = value;
    //ä¾æ¬¡å–å‡ºå›è°ƒæ‰§è¡Œ
    this.resolvedCallbacks.map(cb =&gt; cb());
  }
};
let reject = reason =&gt; {
  if (this.status == 'pending') {
    this.status = 'rejected';
    this.reason = reason;
    //ä¾æ¬¡å–å‡ºå›è°ƒæ‰§è¡Œ
    this.rejectedCallbacks.map(cb =&gt; cb());
  }
};
</code></pre>
<p>åœ¨ then å‡½æ•°æ·»åŠ  pending çŠ¶æ€åˆ¤æ–­</p>
<pre><code class="language-js">//å½“æ—¶ç­‰å¾…çŠ¶æ€æ—¶å€™å­˜æ”¾å¤±è´¥æˆ–æˆåŠŸçš„å›è°ƒ
if (this.status == 'pending') {
  this.rejectedCallbacks.push(() =&gt; {
    onRejected(this.reason);
  });
  this.resolvedCallbacks.push(() =&gt; {
    onFulfilled(this.value);
  });
}
</code></pre>
<p><strong>6ã€è§„èŒƒè§„å®š then å‡½æ•°å¿…é¡»è¿”å›ä¸€ä¸ª promise å¯¹è±¡ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“è§„èŒƒä¸­çš„ promise æ˜¯å’Œé“¾å¼è°ƒç”¨çš„å¦‚ p.then().then()è¿™æ ·å½¢å¼çš„è°ƒç”¨ç”¨æ¥è§£å†³å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦è¿”å›ä¸€ä¸ª promise å¯¹è±¡å¯ä¾›é“¾å¼è°ƒç”¨ï¼Œè§„èŒƒä¸­ç§°å®ƒä¸º promise2 <code>promise2 = promise1.then(onFulfilled, onRejected);</code><br>
7ã€then ä¼šæœ‰ä¸ªè¿”å›å€¼è§„èŒƒä¸­ç§°å®ƒä¸º x å¹¶ä½œä¸ºä¸‹ä¸€ä¸ª promise çš„å‚æ•°è¿›è¡Œä¼ é€’ï¼Œ<br>
è¿™ä¸ª x å€¼å°±æ˜¯ onFulfilled æˆ–è€… onRejected æ‰§è¡Œåçš„è¿”å›å€¼ï¼Œ<br>
å¹¶ä¸”è¿™ä¸ª x å€¼éœ€è¦åšåˆ¤æ–­ï¼Œåˆ¤æ–­çš„å‡½æ•°ä¸º resolvePromiseï¼Œ<br>
å¦‚æœ x æ˜¯æ™®é€šå€¼å°±ç›´æ¥ä½œä¸º promise2 çš„ç»ˆå€¼ï¼Œå¦‚æœ x æ˜¯ promise å°±å–å¾— x çš„æœ€ç»ˆçŠ¶æ€ä½œä¸º promise2 çš„ç»“æœã€‚ resolvePromise æœ‰å››ä¸ªå‚æ•° promise2,x,resolve,reject,å…¶ä¸­ resolve å’Œ reject ä¸º promise2 çš„ã€‚</strong></p>
<p>æ ¹æ®è¿™ä¸¤æ¡å¾—å‡ºä»¥ä¸‹ä»£ç </p>
<pre><code class="language-js"> //thenæ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°onFulfilled,onRejected
    then(onFulfilled, onRejected) {
        // è¿”å›promiseå¯¹è±¡
        let promise2 = new Promise((resolve, reject) =&gt; {
            //å¦‚æœéå‡½æ•°å°±ç›´æ¥è¿”å›å€¼
            onFulfilled = typeof onFulfilled == 'function' ? onFulfilled : v =&gt; v
            // é”™è¯¯çš„å°±ç›´æ¥æŠ›é”™ä¸åœ¨æ‰§è¡Œ
            onRejected = typeof onRejected == 'function' ? onRejected : err =&gt; { throw err }
            //æˆåŠŸåç«‹å³æ‰§è¡Œ,å¹¶å°†å…¶ç»“æœä½œä¸ºå‚æ•°
            if (this.status == 'fulfilled') {
                //x ä¸ºonFufilledçš„å€¼
                let x = onFulfilled(this.value)
                // åˆ¤æ–­xçš„å‡½æ•°
                resolvePromise(promise2, x, resolve, reject)
            }
            // å¤±è´¥åç«‹å³æ‰§è¡Œ,å¹¶å°†å…¶æ‹’å› ä½œä¸ºå‚æ•°
            if (this.status == 'rejected') {
                onRejected(this.reason)
                resolvePromise(promise2, x, resolve, reject)
            }
            //å½“æ—¶ç­‰å¾…çŠ¶æ€æ—¶å€™å­˜æ”¾å¤±è´¥æˆ–æˆåŠŸçš„å›è°ƒ
            if (this.status == 'pending') {
                this.rejectedCallbacks.push(() =&gt; {
                    let x = onRejected(this.reason)
                    resolvePromise(promise2, x, resolve, reject)
                })
                this.resolvedCallbacks.push(() =&gt; {
                    onFulfilled(this.value)
                    resolvePromise(promise2, x, resolve, reject)
                })
            }
        })
        return promise2
    }
</code></pre>
<p><strong>8ã€resolvePromise å®ç°çš„åŠŸèƒ½ä¸»è¦å°±æ˜¯åˆ¤æ–­ x çš„å€¼è§„èŒƒè§„å®šäº†ä»¥ä¸‹å‡ ç‚¹ 1.å¦‚æœ x æŒ‡å‘åŒä¸€å¯¹è±¡å°±æŠ›é”™ï¼Œé˜²æ­¢ç›¸äº’å¼•ç”¨çš„æƒ…å†µå‡ºç°ï¼Œå¹¶ä¸” x ä¸ä¸ºç©ºï¼Œ 2.å¦‚æœ x æ˜¯æ™®é€šå€¼å°±ç›´æ¥ resolve 3.å¦‚æœ x æ˜¯å‡½æ•°æˆ–è€…å¯¹è±¡(åŒ…æ‹¬ promise)<br>
.å®šä¹‰ then å¹¶ä½¿å¾— then = x.then()----promiseA+åŸæ–‡â€˜Otherwise, if x is an object or function,Let then be x.thenâ€™ï¼Œå¹¶æ•è·å– then è¿‡ç¨‹çš„å¼‚å¸¸å¦‚æœå‡ºé”™å°±ç›´æ¥ reject()<br>
.å¦‚æœ then æ˜¯å‡½æ•°å°±è°ƒç”¨ call æ‰§è¡Œ this ä¸ºå½“å‰çš„ x,åé¢åˆ†åˆ«æ˜¯æˆåŠŸå’Œå¤±è´¥çš„å›è°ƒï¼Œå¦‚æœ then éå‡½æ•°å°±ç›´æ¥ resolve<br>
.å¹¶ä¸”æˆåŠŸå’Œå¤±è´¥åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œå› æ­¤æˆ‘ä»¬è¦å®šä¹‰ä¸€ä¸ª called æ¥æ ‡è®°æ˜¯å¦å·²ç»æ‰§è¡Œè¿‡æˆåŠŸæˆ–å¤±è´¥çš„å›è°ƒï¼Œå¦‚æœæˆåŠŸçš„è¿”å›å€¼ä»ç„¶æ˜¯ Promise å°±é€’å½’è°ƒç”¨ resovlePromise å‡½æ•°</strong></p>
<p>æ ¹æ®è¿™æ¡æˆ‘ä»¬æ¥å†™ resovlePromise å‡½æ•°</p>
<pre><code class="language-js">function resolvePromise(promise2, x, resolve, reject) {
  if (x == promise2) {
    return new TypeError('Error');
  }
  let called = false; //å®šä¹‰æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤è°ƒç”¨
  // x ä¸èƒ½ä¸ºç©ºï¼Œä¸”ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°æ—¶ï¼Œä¸ºæ™®é€šå€¼å°±ç›´æ¥resovle
  if (x != null &amp;&amp; (typeof x == 'object' || typeof x == 'function')) {
    //å®šä¹‰then å¹¶æ•è·å¼‚å¸¸
    try {
      let then = x.then();
      //å¦‚æœthenä¸ºå‡½æ•°ï¼Œé»˜è®¤ä¸ºpromiseå¯¹è±¡å°±ç»§ç»­é€’å½’è§£æ
      if (typeof then == 'function') {
        then.call(
          x,
          y =&gt; {
            //åªå…è®¸è¢«è°ƒç”¨ä¸€æ¬¡
            if (called) return;
            called = true;
            resolvePromise(promise2, y, resolve, reject);
          },
          err =&gt; {
            if (called) return;
            called = true;
            reject(err);
          }
        );
      } else {
        if (called) return;
        called = true;
        resolve(x);
      }
    } catch (error) {
      if (called) return;
      called = true;
      reject(error);
    }
  } else {
    resolve(x);
  }
}
</code></pre>
<p>å¥½äº†è¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº†ä¸€ä¸ªç¬¦åˆè§„èŒƒçš„ Promise</p>
<p>é™„ä¸Š all,race,resolve,rejectï¼Œcatch,finlly ä»£ç </p>
<pre><code class="language-js">Promise.resolve = function(v) {
  return new Promise((resolve, reject) =&gt; {
    resolve(v);
  });
};
Promise.reject = function(err) {
  return new Promise((resolve, reject) =&gt; {
    resolve(err);
  });
};
Promise.race = function(promises) {
  return new Promise((resolve, reject) =&gt; {
    for (let i = 0; i &lt; promises.length; i++) {
      promises[i].then(resolve, reject);
    }
  });
};
Promise.all = function(promises) {
  let arr = [];
  let index = 0;
  return new Promise((resolve, reject) =&gt; {
    for (let i = 0; i &lt; promises.length; i++) {
      promises[i].then(data =&gt; {
        addResult(i, data);
      }, reject);
    }
    function addResult(i, data) {
      if (index == arr.length) {
        resolve(arr);
      }
      index++;
      arr[i].push(data);
    }
  });
};
Promise.catch = function(errFn) {
  return this.then(null, errFn);
};
Promise.finally = function(fn) {
  this.then(
    () =&gt; {
      fn();
    },
    () =&gt; {
      fn();
    }
  );
  return this;
};
</code></pre>
<p>å®Œæ•´ä»£ç </p>
<pre><code class="language-js">
class Promise {
    constructor(executor) {
        //çŠ¶æ€
        this.status = 'pending'
        //å¤±è´¥çš„å€¼
        this.reason = null
        //æˆåŠŸçš„å€¼
        this.value = null
        //æˆåŠŸå›è°ƒå­˜æ”¾
        this.resolvedCallbacks = []
        //å¤±è´¥å›è°ƒå­˜æ”¾
        this.rejectedCallbacks = []
        let resolve = (value) =&gt; {
            if (this.status == 'pending') {
                this.status = 'fulfilled'
                this.value = value
                //ä¾æ¬¡å–å‡ºå›è°ƒæ‰§è¡Œ
                this.resolvedCallbacks.map(cb =&gt; cb())
            }
        }
        let reject = (reason) =&gt; {
            if (this.status == 'pending') {
                this.status = 'rejected'
                this.reason = reason
                //ä¾æ¬¡å–å‡ºå›è°ƒæ‰§è¡Œ
                this.rejectedCallbacks.map(cb =&gt; cb())
            }
        }
        //å½“è°ƒç”¨æ„é€ å‡½æ•°æ—¶å°±è°ƒç”¨executorå‡½æ•°å¹¶æ•è·å¼‚å¸¸
        try {
            executor(resolve, reject)
        } catch (error) {
            reject(error)
        }
    }
    //thenæ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°onFulfilled,onRejected
    then(onFulfilled, onRejected) {
        // è¿”å›promiseå¯¹è±¡
        let promise2 = new Promise((resolve, reject) =&gt; {
            //å¦‚æœéå‡½æ•°å°±ç›´æ¥è¿”å›å€¼
            onFulfilled = typeof onFulfilled == 'function' ? onFulfilled : v =&gt; v
            // é”™è¯¯çš„å°±ç›´æ¥æŠ›é”™ä¸åœ¨æ‰§è¡Œ
            onRejected = typeof onRejected == 'function' ? onRejected : err =&gt; { throw err }
            //æˆåŠŸåç«‹å³æ‰§è¡Œ,å¹¶å°†å…¶ç»“æœä½œä¸ºå‚æ•°
            if (this.status == 'fulfilled') {
                //x ä¸ºonFufilledçš„å€¼
                let x = onFulfilled(this.value)
                // åˆ¤æ–­xçš„å‡½æ•°
                resolvePromise(promise2, x, resolve, reject)
            }
            // å¤±è´¥åç«‹å³æ‰§è¡Œ,å¹¶å°†å…¶æ‹’å› ä½œä¸ºå‚æ•°
            if (this.status == 'rejected') {
                onRejected(this.reason)
                resolvePromise(promise2, x, resolve, reject)
            }
            //å½“æ—¶ç­‰å¾…çŠ¶æ€æ—¶å€™å­˜æ”¾å¤±è´¥æˆ–æˆåŠŸçš„å›è°ƒ
            if (this.status == 'pending') {
                this.rejectedCallbacks.push(() =&gt; {
                    let x = onRejected(this.reason)
                    resolvePromise(promise2, x, resolve, reject)
                })
                this.resolvedCallbacks.push(() =&gt; {
                    onFulfilled(this.value)
                    resolvePromise(promise2, x, resolve, reject)
                })
            }
        })
        return promise2
    }
}
function resolvePromise(promise2, x, resolve, reject) {
    if (x == promise2) {
        return new TypeError('Error')
    }
    let called = false //å®šä¹‰æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤è°ƒç”¨
    // x ä¸èƒ½ä¸ºç©ºï¼Œä¸”ä¸ºå¯¹è±¡æˆ–è€…å‡½æ•°æ—¶ï¼Œä¸ºæ™®é€šå€¼å°±ç›´æ¥resovle
    if (x != null &amp;&amp; (typeof x == 'object' || typeof x == 'function')) {
        //å®šä¹‰then å¹¶æ•è·å¼‚å¸¸
        try {
            let then = x.then()
            //å¦‚æœthenä¸ºå‡½æ•°ï¼Œé»˜è®¤ä¸ºpromiseå¯¹è±¡å°±ç»§ç»­é€’å½’è§£æ
            if (typeof then == 'function') {
                then.call(x, y =&gt; {
                    //åªå…è®¸è¢«è°ƒç”¨ä¸€æ¬¡
                    if (called) return
                    called = true
                    resolvePromise(promise2, y, resolve, reject)
                }, err =&gt; {
                    if (called) return
                    called = true
                    reject(err)
                })
            } else {
                if (called) return
                called = true
                resolve(x)
            }
        } catch (error) {
            if (called) return
            called = true
            reject(error)
        }
    } else {
        resolve(x)
    }
}
Promise.resolve = function (v) {
    return new Promise((resolve, reject) =&gt; {
        resolve(v)
    })
}
Promise.reject = function (err) {
    return new Promise((resolve, reject) =&gt; {
        reject(err)
    })
}
Promise.race = function (promises) {
    return new Promise((resolve, reject) =&gt; {
        for (let i = 0; i &lt; promises.length; i++) {
            Promise.resolve(promises[i]).then((resolve,reject));
        }
    })
}
Promise.all = function (promises) {
    let arr = []
    let index = 0;
   let resultarr =[];
   let count = 0;
   len asynclen = promises.length
    return new Promise((resolve, reject) =&gt; {
        for (let i = 0; i &lt;asynclen ; i++) {
            promises[i].then((value) =&gt; {
                count++;
                resultarr.push(value);
               if(count==asynclen ){
                      resolve(resultarr)
                 }
            }, reject)
        }
    })
}
Promise.catch = function (errFn) {
    return this.then(null, errFn);
}
Promise.finally = function (fn) {
    this.then(() =&gt; {
        fn();
    }, () =&gt; {
        fn();
    });
    return this;
}

</code></pre>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E4%B8%80-promise-%E6%98%AF%E4%BB%80%E4%B9%88">ä¸€ã€Promise æ˜¯ä»€ä¹ˆï¼Ÿ</a></li>
<li><a href="#%E4%BA%8C-promise-%E7%9A%84%E5%87%BA%E7%8E%B0%E4%B8%BA%E4%BA%86%E8%A7%A3%E5%86%B3%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98">äºŒã€Promise çš„å‡ºç°ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ</a></li>
<li><a href="#%E4%B8%89-%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AC%A6%E5%90%88-promisea%E8%A7%84%E8%8C%83%E7%9A%84-promise">ä¸‰ã€æ‰‹å†™ä¸€ä¸ªç¬¦åˆ PromiseA+è§„èŒƒçš„ Promise</a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://icyfe.github.io/icyblog/post/shi-xian-yi-ge-jian-dan-de-mvvm/">
              <h3 class="post-title">
                å®ç°ä¸€ä¸ªç®€å•çš„ MVVM
              </h3>
            </a>
          </div>
        

        
          
            <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>

<script>

  var gitalk = new Gitalk({
    clientID: 'b5c28ec6bd13b8deb4f2',
    clientSecret: '4f8fb75044211e6b3cfade41f69a78185924b102',
    repo: 'icyblog',
    owner: 'icyfe',
    admin: ['icyfe'],
    id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')

</script>

          

          
        

        <div class="site-footer">
  ok fine~
  <a class="rss" href="https://icyfe.github.io/icyblog//atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
